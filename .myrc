# Fig pre block. Keep at the top of this file.
[[ -f "$HOME/.fig/shell/zshrc.pre.zsh" ]] && builtin source "$HOME/.fig/shell/zshrc.pre.zsh"
# enable poetry in zsh
fpath+=~/.zfunc


PATH=/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin:~/bin
export PATH=/Users/andreys/.pyenv/bin:/Users/andreys/.poetry/bin:/usr/local/bin:$PATH

eval "$(/opt/homebrew/bin/brew shellenv)"


# Disable pip installs outside of virtualenvs
export PIP_REQUIRE_VIRTUALENV=true

# Disable annoying pyenv venv prompt
export PYENV_VIRTUALENV_DISABLE_PROMPT=1

# solves issues with pip
export DYLD_LIBRARY_PATH=/usr/local/Cellar/openssl@1.1/1.1.1i/lib:/usr/local/Cellar/mysql@5.7/5.7.32/lib
export CPPFLAGS='-I/usr/local/Cellar/openssl@1.1/1.1.1i/include'
export LDFLAGS='-L/usr/local/Cellar/openssl@1.1/1.1.1i/lib'
#gradle
export PATH="/usr/local/opt/openjdk/bin:$PATH"
export PATH=$PATH:/usr/local/Cellar/mysql@5.7/5.7.32/bin
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
# Add Visual Studio Code (code)


# Doing it here in order for pipx installed packages to have precedence over venv names
export PATH=/Users/andreys/.local/bin:$PATH
export PATH=/usr/local/go/bin:$PATH
export PATH=/Users/andreys/.cargo/bin:$PATH

#Terminal

COLOR_DEF=$'%f'
COLOR_USR=$'%F{243}'
COLOR_DIR=$'%F{197}'
COLOR_GIT=$'%F{39}'

function parse_git_branch() {
    git branch 2> /dev/null | sed -n -e 's/^\* \(.*\)/[\1]/p'
}

function __kube_ps1()
{
    # Get current context
    CONTEXT=$(cat ~/.kube/config | grep "current-context:" | sed "s/current-context: //")

    if [ -n "$CONTEXT" ]; then
        echo "(k8s: ${CONTEXT})"
    fi
}

function _update_prompt() {
    export PROMPT='${COLOR_USR}%n ${COLOR_DIR}%~ ${COLOR_GIT}$(parse_git_branch)${COLOR_DEF} $(__kube_ps1) $ '
}

function chpwd() {
    _update_prompt
}

function preexec_kx_hook() {
    if [[ $1 == "kx" ]]; then
        # Do something when 'kx' command is executed
        _update_prompt
    fi
}

autoload -Uz add-zsh-hook
add-zsh-hook preexec preexec_kx_hook

setopt PROMPT_SUBST
_update_prompt
add-zsh-hook chpwd

#Python
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init --path)"
eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

export USE_GKE_GCLOUD_AUTH_PLUGIN=True
#########
# ALIASES
#########

## Git
alias gs='git status'
alias ga='git add'
alias gd='git diff'
alias gc='git add . && git commit --all --message'
alias gcr='git checkout master && git pull && git checkout - && git rebase -i master'
alias gl="git log --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --graph"
alias gcm="git checkout main"
alias gcms="git checkout master"
alias gbc="git pull && git checkout -b ${1}"
alias gpu="git pull"
alias gcmu="gcm && gpu"
alias gcmasteru="gcms && gpu"
alias gss="git stash save --include-untracked"
alias gsp="git stash pop"
alias grc="git rebase --continue"
alias grm="git rebase -i master"
alias gco="git checkout $1 && $(_update_prompt)"
alias gcp="git checkout -"
alias gp="git push"
alias gpf="git push -f"
alias gbd="git branch -D"
alias gdm='git diff main'
alias gca='git commit --amend'
alias gitm='git commit --message'


## AWS
alias aws='~/.local/bin/aws2/aws-cli/aws'
## dev
alias cdev='cd ~/dev'
alias ll="ls -al"
alias ssogcp="gcloud auth login"
alias tg="terragrunt"
alias tf="terraform"
alias t="terraform"
alias code="code-insiders"
## k8s
alias kubectl="/usr/local/bin/kubectl"
alias k="kubectl"
alias kg="kubectl get"
alias kgns="kubectl get namespace"
alias kx="kubectx && $(_update_prompt)"

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh


# CLI tools i use
# fzf
# enable zsh autocomplete by /opt/homebrew/opt/fzf/install
# Fig post block. Keep at the bottom of this file.
[[ -f "$HOME/.fig/shell/zshrc.post.zsh" ]] && builtin source "$HOME/.fig/shell/zshrc.post.zsh"
